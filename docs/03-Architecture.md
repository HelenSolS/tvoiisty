# 03. Архитектура (MVP → масштабирование)

## 3.1. Принципы
- MVP должен быть простым, но с правильными границами модулей.
- Все AI-вызовы идут через абстракцию `AIProvider`.
- Долгие операции — через очередь задач и статусы.
- Списание токенов — только после `COMPLETED`.

## 3.2. Компоненты системы
### Frontend
- Telegram Mini App (Web): React/Next/Vite.
- Отвечает за UX, выбор фото/образа/локации, отображение статусов.

### Backend API
- Авторизация Telegram initData.
- CRUD для образов, локаций, пользователей.
- Создание задач примерки/анимации.
- Выдача статусов и результатов.
- События аналитики (view, tryon, click).

### Worker (AI pipeline)
- Забирает задания из очереди.
- Делает:
  - валидацию
  - модерацию
  - подготовку промпта
  - вызов AI
  - сохранение результата
  - обновление статуса

### Storage
- Хранилище файлов (S3-compatible или облако).
- Раздельные бакеты: user-photos, outfits, locations, results, videos.

### DB
- Postgres.

## 3.3. Поток «примерка» (job)
1) Front вызывает `POST /tryons` с `user_photo_id`, `outfit_id`, `location_id?`.
2) Backend создаёт `TryOnJob` со статусом `RECEIVED` и кладёт в очередь.
3) Worker:
   - `VALIDATING` (проверка формата, размеров, корректности ссылок)
   - `MODERATING` (NSFW + базовая проверка качества)
   - `PROMPTING` (генерация инструкций/параметров)
   - `RUNNING` (вызов AI)
   - `UPLOADING` (сохранение результата)
   - `COMPLETED` или `FAILED`
4) Backend отдаёт статус через `GET /tryons/{id}`.

Важное: Front должен опрашивать статус с backoff (например, 1s → 2s → 4s → 8s).

## 3.4. Поток «анимация» (job)
1) На экране результата пользователь жмёт «Анимировать».
2) Front вызывает `POST /animations` с `tryon_id`.
3) Backend создаёт `AnimationJob` со статусом `RECEIVED`.
4) Worker генерирует видео.
5) Результат хранится как mp4 + превью.

## 3.5. Контроль качества и модерация
### Для изображений пользователя
- Проверка разрешения.
- Проверка “не пусто” (не однотонное).
- Проверка размытия (blur score).
- NSFW-детектор.

### Для образов магазина
- То же + минимальные требования к композиции.

### Для локаций
- Проверка качества.
- Теги/описание для будущего поиска.

## 3.6. “Два контура” (заложить, но не реализовывать в MVP)
Архитектурная возможность:
- Контур A (RF): web + DB + storage + публичные API.
- Контур B (KZ/EU): worker для AI вызовов (если в РФ недоступны провайдеры).

Техническая закладка сейчас:
- Worker должен уметь работать как отдельный сервис в другом регионе.
- Файлы для обработки должны передаваться через временные pre-signed URL.
- Worker не хранит данные постоянно; только читает → генерит → кладёт результат обратно.

## 3.7. Провайдеры AI (абстракция)
Должен быть интерфейс:
- `tryOn(userPhotoUrl, outfitUrl, locationUrl?) -> resultUrl`
- `animate(imageUrl) -> videoUrl`

Внутри реализация может меняться без изменения API.

## 3.8. Статусы задач (единый словарь)
- `RECEIVED`
- `VALIDATING`
- `MODERATING`
- `QUEUED`
- `RUNNING`
- `UPLOADING`
- `COMPLETED`
- `FAILED`

Для UX отображать “человеческие” статусы.

