# План развития: автотесты, регрессия, ключи и токены

## 1. Промпт и примерка

### 1.1. Если процесс прерван — нет промпта

- **Не отправлять запрос на примерку** без валидного промпта.
- Фронт: при ошибке или пустом ответе от `/api/prepare-tryon-prompt` не вызывать `/api/generate-image`. Показать пользователю ошибку.
- Бэкенд: при сбое основного пути (Vision / Prompt Builder) — **цепочка альтернатив: один сброс, сразу в следующую** (без лишних повторов):
  1. **OpenAI simple** (gpt-4o-mini + картинка) — один запрос, короткий промпт.
  2. **Fal LLM** (FAL_KEY, например Mixtral через `queue.fal.run`) — текстовый чат по описанию/JSON одежды.
  3. **Fal через OpenAI-прокси** (если заданы `FAL_OPENAI_PROXY_URL` и `FAL_PROXY_API_KEY`, например [fal-openai-cf-proxy](https://github.com/Loongphy/fal-openai-cf-proxy)) — тот же чат в формате OpenAI.
- В перспективе можно добавить KIE в цепочку (если появится подходящий эндпоинт для описания/промпта).

### 1.2. Уведомление админа при сбоях

- При сбоях подготовки промпта (в т.ч. возможное окончание токенов) нужно **повещать админа**.
- Реализовано:
  - Лог с префиксом `[prepare-tryon-prompt] [ADMIN]` — всегда пишется при fallback, отсутствии ключа, 401/429.
  - Опционально: `ADMIN_WEBHOOK_URL` в окружении — POST с телом `{ reason, stage, ts, ... }` (например, Slack/Telegram бот).
- Причины уведомлений:
  - `openai_key_missing` — не задан OPENAI_API_KEY.
  - `openai_quota_or_auth` — 401 или 429 от OpenAI (проверить токены/лимиты).
  - `fallback_used` — сработала альтернатива (для мониторинга).
  - `fallback_failed` — и основной путь, и альтернатива упали.
- **За токенами и ключами следить нужно** — при частых 429/401 проверять квоты и ключи в кабинетах провайдеров.

---

## 2. Автотесты: регрессия и ключи

### 2.1. Регрессия

- В CI (на каждый PR и при пуше в dev/main) запускать:
  - линт и typecheck;
  - юнит-тесты;
  - при наличии — интеграционные тесты на критические сценарии (например: вызов `/api/prepare-tryon-prompt` с моком изображения и проверка формата ответа без реального OpenAI).
- Добавить/держать тесты на:
  - парсинг JSON от Vision (Zod-схема, fallback при невалидном JSON);
  - формирование тела запроса к Fal/KIE (промпт и URL картинок не теряются).
- Цель: **проверять регрессию** — изменения в промптах, эндпоинтах и форматах не ломают пайплайн без сигнала в CI.

### 2.2. Ключи и токены

- В плане на будущее (отдельные задачи/Issue):
  - **Проверка ключей в CI (smoke):** опциональный шаг в workflow (например, только в cron или по метке), который проверяет доступность сервисов с тестовыми ключами (или моками), без расхода прод-токенов.
  - **Мониторинг квот:** периодическая проверка или алерты при 429 от OpenAI/Fal/KIE (логи уже пишут [ADMIN]; можно агрегировать в мониторинге).
  - Документировать в одном месте: какие ключи нужны (OPENAI_API_KEY, FAL_KEY, KIE_API_KEY), где их брать и как следить за лимитами.

### 2.3. Чеклист перед релизом

- Линт и тесты зелёные.
- Ключи в Vercel/окружении актуальны, квоты не исчерпаны.
- При сбоях промпта в логах есть [ADMIN] и при необходимости срабатывает webhook.

---

---

## 4. Сборка и импорты на Vercel (ESM)

- **Импорты из `lib/` в API:** в ESM Node на Vercel нужен явный `.js` в пути:
  `import { ... } from '../lib/ai/garment-schema.js'` (исходник остаётся `.ts`, в рантайме резолвится `.js`).
- **Регистр имён:** везде единообразно lowercase (`garment-schema.ts`, не `Garment-schema.ts`), иначе Mac пройдёт, Linux на Vercel — нет.
- **Проверка перед деплоем:** `git ls-files | grep garment` — файлы из `lib/ai/` должны быть в репозитории.
- **Сборка:** убедиться, что в артефакте деплоя (или в `.vercel/output`) есть скомпилированные `lib/ai/*.js`; при необходимости добавить шаг сборки/копирования для serverless.

---

*Документ обновлять по мере появления новых автотестов и правил мониторинга.*
