# Отчёт: как реально работает система и граница первого этапа

**Цель документа:** описать реализованную функциональность, что настраивается, что нет, какие вопросы закрыты и какие ещё решать. Использовать для решения, на чём остановить первый этап.

---

## 1. Что реализовано (по веткам и срезу кода)

### 1.1. Основной поток приложения (есть везде: main, dev, ветки)

- **Экраны (вкладки):** Главная (примерочная), Архив, Настройки, Витрина магазина (Showroom), Лаборатория, Админ-панель (по паролю).
- **Пользователь:** локальный объект в state + `localStorage` (`STORAGE_VER_user`). Роли: `user` / `merchant`. Верификация магазина — заглушка (кнопки «Госуслуги» / «T-Bank ID» → сразу `isVerifiedMerchant: true`). Регистрация при первом «Примерить» — модалка «Войти» (без реального бэкенда).
- **Темы:** `turquoise` | `lavender` | `peach`, переключаются в Настройках, сохраняются в user и в `document.body.className`.
- **Каталог образов:** мерчантские товары (`merchantProducts`) + захардкоженный `INITIAL_BOUTIQUE`. Категории, поиск, фильтр по категории. Кнопка «Примерить» на карточке → быстрая примерка (фото пользователя + образ).

### 1.2. Примерка (try-on)

- **Фронт:** фото человека (галерея или загрузка), выбор образа из каталога, опционально — загрузка «фото вещи» для Лаборатории. Перед запросом вызывается `prepareTryonPrompt` (person + garment base64) → получаем промпт. Затем `generateTryOn` → `POST /api/generate-image` с `personImageBase64`, `clothingImageBase64`, `prompt`, опционально `model`.
- **Бэкенд (Vercel):** `api/generate-image.ts` — Provider Abstraction: по `model` выбирается Fal или KIE. Fal: очередь + polling с увеличенным таймаутом и последним опросом перед 408. KIE: createTask + polling. При ошибке Fal (не таймаут) — fallback на KIE; при таймауте 408 fallback не делается (чтобы не дублировать запрос). Результат — `imageUrl` (URL, при необходимости загрузка в Vercel Blob).
- **Промпт:** `POST /api/prepare-tryon-prompt` — единый стандартный промпт (без вызова OpenAI в продакшене). Опционально админ-уведомление в webhook.
- **Итог:** пользователь видит результат на экране; при успехе запись добавляется в архив (если URL не data URL).

### 1.3. Видео (анимация)

- **Фронт:** кнопка «Создать видео» на результате примерки или «Анимировать» в модалке архива. Вызов `generateVideo(resultImageUrl, { model, prompt })` → `POST /api/generate-video`.
- **Бэкенд:** `api/generate-video.ts` — KIE: Veo, Runway, Kling, Hailuo, Wan, Grok (jobs/createTask или veo/runway endpoints), polling до готовности или таймаут. Модель передаётся с фронта (из настроек или выпадающего списка).
- **Результат:** URL видео показывается на экране; в архиве у записи можно сохранить `videoUrl` (при нажатии «Анимировать» в модалке архива).

### 1.4. Архив

- **На main / без ветки #20:** история в `localStorage` (`STORAGE_VER_history`), лимит 20, без IndexedDB.
- **В ветке feat/issue-20-user-archive (локально):**  
  - Хранилище: **IndexedDB** (основной), при первом запуске — миграция из `localStorage`, дальше в localStorage для истории не пишем.  
  - Лимит **50** записей (`ARCHIVE_MAX_ITEMS`), при переполнении самая старая удаляется.  
  - Над сеткой подпись: «Хранятся последние 50 примерок».  
  - При первом переполнении за сессию — тост: «Самая старая запись удалена».  
  - В архив не сохраняются data URL (только URL).  
  - В модалке записи: Купить в магазине, Анимировать, Скачать фото, Поделиться, при наличии видео — плеер, Скачать видео, Поделиться видео.

### 1.5. Магазин (мерчант) и коллекции

- **Витрина (Showroom):** список `merchantProducts` + счётчики (товаров; кликов пока 0). Добавление одного товара: модалка с именем, картинкой, категорией, ссылкой на магазин → сохранение в state и в `localStorage` (`STORAGE_VER_merchant_products`).
- **Ветка feat/issue-21-shop-collection-upload (отдельно):** мультизагрузка до 10 фото, общее название/ссылка/категория, «Опубликовать коллекцию» → каждый образ сохраняется как `CuratedOutfit` в `merchantProducts` и в `localStorage`. Лимит архива там не менялся (в той ветке может быть ещё 20).

### 1.6. Админка и настройки

- **Доступ:** Настройки → поле пароль → «888» → переход в Админ-панель. Флаг в `sessionStorage` (`tvoisty_admin_unlocked`) — в той же сессии в шапке показывается иконка шестерёнки для быстрого перехода в Настройки.
- **Хранение настроек:** только `localStorage` (`tvoisty_admin_settings`). Сервера для настроек нет.
- **Что настраивается (AdminSettings):**
  - Провайдер примерки: **KIE** или **Fal** (приоритет для картинки).
  - Модель по умолчанию для картинки и для видео (из пулов).
  - Режим выбора модели: «только по умолчанию» или «выпадающий список» (отдельно для фото и видео).
  - Списки моделей в выпадающих списках (фото/видео).
  - Запасные модели (для fallback картинки и для видео).
  - Режимы промпта: **default** (редактируемый текст), **openai** (через Fal), **custom** (свой текст). Отдельно для примерки и для видео.
  - Тексты промптов по умолчанию и кастомные.
  - **imageFallbackEnabled:** при ошибке первой модели (KIE) пробовать Fal; при выключении — не fallback.
  - **showModelChoiceOnHome:** показывать ли выбор моделей (фото/видео) на главном экране. Выбор на главном виден только если ещё и выбран режим «выпадающий список» для соответствующей модели.
- **Кнопки в админке:** «Сохранить», «Вернуть стабильность» (сброс в стабильные дефолты + сохранение).
- **Дефолты для показа:** Fal Banana для картинки, KIE Kling для видео, провайдер Fal.

### 1.7. Лаборатория

- Отдельный экран: загрузка человека, загрузка образа, выбор модели примерки из пула, вызов примерки; для видео — выбор модели видео. Нужна для тестов и демо без смены глобальных настроек на главной.

### 1.8. Инфраструктура и ключи

- **Деплой:** фронт + API на Vercel. Импорты в `api/` с расширением `.js` (ESM).
- **Ключи (env):** для примерки/видео — KIE_API_KEY, FAL_KEY; для загрузки результатов — BLOB_READ_WRITE_TOKEN (публичный Blob). Без ключей соответствующие провайдеры возвращают 500/сообщение об ошибке.
- **Очереди/воркеры:** нет. Синхронный с точки зрения API поток: запрос → polling внутри handler до готовности или таймаут.

---

## 2. Что настраивается, а что нет

| Область | Настраивается | Не настраивается (зашито / заглушка) |
|--------|----------------|--------------------------------------|
| Провайдер и модели примерки/видео | Да, через админку (localStorage) | Пул моделей задан в коде (IMAGE_MODEL_POOL, VIDEO_MODEL_POOL) |
| Промпты примерки и видео | Да (default/openai/custom, тексты) | Логика prepare-tryon на бэкенде фиксированная |
| Fallback KIE→Fal | Да (вкл/выкл) | Поведение при таймауте (не fallback) зашито |
| Показ выбора моделей на главной | Да (чекбокс + режим «выпадающий список») | Условие «два чекбокса» оставлено по твоему решению |
| Темы | Да (turquoise/lavender/peach в настройках) | Набор тем фиксирован |
| Лимит архива | Нет (константа 50 в ветке #20) | При желании — вынести в настройки позже |
| Авторизация | Нет (модалка «Войти», верификация магазина — заглушка) | Реальная авторизация и бэкенд-проверка не сделаны |
| Статистика (клики, примерки) | Нет | Счётчики в Showroom захардкожены (0); метрики Issue #29 не подключены |
| Каталог/категории | Частично (мерчант добавляет товары, категория из списка) | INITIAL_BOUTIQUE и список категорий в коде |

---

## 3. Какие вопросы решены

- **Примерка не падает на таймауте при готовой картинке:** увеличен таймаут опроса Fal, последний опрос перед 408, при COMPLETED возвращаем 200.
- **Не дублировать запрос при 408:** fallback на KIE только при явной ошибке, не при таймауте.
- **Деплой на Vercel:** провайдеры в `api/_lib`, импорты с `.js`.
- **Админка:** один источник настроек (localStorage), дефолты для показа, кнопка «Вернуть стабильность».
- **Архив (в ветке #20):** один источник правды (IndexedDB), лимит 50, прозрачность для пользователя (подпись + тост при переполнении), без base64 в архиве.
- **Поделиться видео:** кнопка в модалке архива при наличии видео.

---

## 4. Что нужно решать / оставить на потом

- **Граница первого этапа:** что в него входит по веткам (например: dev в main; #20 в main; #21 в main; или только dev).
- **Метрики (Issue #29):** локальные счётчики (примерки, видео, шары, клики в магазин, сохранения в архив, коллекции, образы) + панель в Showroom/Admin + derived (CTR, Video Conversion, Save Rate) + Reset для демо. Пока не делали — порядок: сначала магазины, потом метрики.
- **Дизайн и UX:** премиальный вид, листалка, влезание фото на ПК (и проверка на телефоне), выравнивание размеров и цветов — без потери утверждённого; согласовывать с дизайнером.
- **Авторизация и бэкенд-проверки:** по MVP-документам — позже.
- **Серверная аналитика и облачный архив:** не в первом этапе.

---

## 5. Варианты «на чём остановить первый этап»

**Вариант A — Минимум для стабильного демо**  
- В main попадает только **dev**: фиксы примерки (Fal/таймаут/fallback), админка, дефолты.  
- Архив остаётся как на main (localStorage, 20).  
- Магазины и метрики — после этапа.

**Вариант B — Демо + надёжный архив**  
- В main: **dev** + **feat/issue-20-user-archive** (IndexedDB, 50, тост, «Поделиться видео»).  
- Магазины (#21) и метрики (#29) — следующий этап.

**Вариант C — Демо + архив + магазин**  
- В main: **dev** + **#20** + **feat/issue-21-shop-collection-upload**.  
- Метрики (#29) и полировка дизайна — следующий этап.

**Вариант D — Всё запланированное для «первого этапа»**  
- В main: dev + #20 + #21 + метрики (#29) после реализации.  
- Затем фокус на дизайн/листалка/премиум-вид.

Рекомендация для выбора: если важно показать инвестору «ничего не теряется» и «архив предсказуем» — минимум **B**. Если нужны коллекции магазина в демо — **C**. Метрики логично подключать после того, как зафиксируешь границу этапа по функциональности (A/B/C/D).

---

## 6. Краткая сводка по веткам (на момент отчёта)

| Ветка | Содержимое | Запушена | В main |
|-------|------------|----------|--------|
| main | PR #10 (model choice), без Fal-фиксов и без архива #20 | — | да |
| dev | Fal-фиксы, админка, дефолты, импорты .js | да | нет |
| feat/issue-20-user-archive | Архив IndexedDB, 50, тост, share video, guardrails | нет (локально) | нет |
| feat/issue-21-shop-collection-upload | Загрузка коллекции до 10 фото, публикация в merchantProducts | да | нет |

---

*Документ можно дополнять при появлении новых веток или решений (например, после внедрения Issue #29 или смены порядка магазины/метрики).*
