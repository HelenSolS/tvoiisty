# Обязательные проверки: примерка (generate-image) и fallback KIE → Fal

Документ для тестировщика. Эти проверки **обязательны** при приёмке и при **регрессионном тестировании**. От них зависит корректность и стоимость (не делаем лишний запрос в Fal при успешном KIE).

---

## 1. Ответ 200 = всегда есть картинка

- **Правило:** При HTTP 200 от `POST /api/generate-image` в теле ответа **обязательно** есть поле `imageUrl` (строка, не пустая).
- **Проверка:** Вызвать примерку до успешного ответа → в ответе `status === 200`, в body есть `imageUrl`, по ссылке открывается изображение.
- **Регресс:** Никогда не должно быть ситуации «200 OK, но картинки нет» или «в интерфейсе ошибка, хотя картинка пришла». Если 200 — в UI должна отображаться картинка.

---

## 2. Ошибка = без imageUrl, клиент показывает ошибку

- **Правило:** При ответе с кодом ошибки (4xx/5xx) в теле есть `error` (текст для пользователя), **нет** валидного `imageUrl` в успешном смысле.
- **Проверка:** Симулировать ошибку (неверный ключ, таймаут и т.п.) → код не 200, пользователь видит сообщение об ошибке, картинка не показывается как успех.

---

## 3. Fallback KIE → Fal только при реальной ошибке KIE

- **Правило:** Повтор запроса в Fal делается **только** если KIE вернул ошибку (не 200, нет успешного результата). Если KIE вернул 200 и `imageUrl` — второго запроса в Fal **не должно быть**.
- **Проверка:** Выбрать модель KIE (например flux-2), сделать примерку до успеха → в логах/сетевых запросах один успешный ответ от нашего API, **один** вызов к провайдеру (KIE). Не должно быть двух запросов к разным провайдерам за один сценарий «успешная примерка».
- **Регресс:** При стабильной работе KIE fallback в Fal не вызывается. Вызов Fal после успешного KIE — баг (бессмысленно и дорого).

---

## 4. Стабильность запросов

- **Правило:** Запросы к KIE и Fal должны быть оформлены так, чтобы успешный ответ обрабатывался однозначно: 200 + валидный `imageUrl` = успех, иначе не считаем успехом.
- **Проверка:** Повторить сценарий примерки (KIE и Fal модели) несколько раз → при успешном ответе картинка всегда отображается, при ошибке — всегда показывается сообщение об ошибке, без «200 но ошибка сверху» или «картинки нет, но она есть».

---

## 5. Чек-лист перед релизом (регресс)

- [ ] Успешный ответ 200 всегда содержит `imageUrl` и картинка отображается в UI.
- [ ] Нет сценария «200 в ответе, но в интерфейсе ошибка» или «картинки нет, хотя она есть».
- [ ] При успешной примерке через KIE fallback в Fal не выполняется (один запрос к провайдеру).
- [ ] При ошибке KIE (если настроен Fal) выполняется один повтор в Fal; при успехе Fal пользователь получает картинку.
- [ ] Ошибки (4xx/5xx) приводят к показу сообщения пользователю и отсутствию отображения картинки как успеха.

---

*При изменении логики примерки, fallback или формата ответа API — обновлять этот документ и прогонять проверки.*
