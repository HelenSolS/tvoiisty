# 09. GitHub процесс: ветки, PR, CI

## 9.1. Ветки и порядок работы
**Обязательно: сначала dev, потом main.** Эксперименты и фичи (в т.ч. лаборатория) — только в dev; в main только через PR из dev после проверки.

- `main` — только прод, только протестированное. Не мержить сюда экспериментальные/feature-ветки напрямую.
- `dev` — активная интеграция фич и экспериментов.
- `test` — по необходимости, стабилизация перед релизом.

Рекомендуемый поток:
1) От `dev` создаётся feature-ветка: `feat/<issue-id>-short-name` или `fix/...`.
2) PR → **dev** (не в main).
3) После набора фич: PR `dev` → `test` (если есть) или сразу PR `dev` → `main`.
4) В `main` попадает только код, уже проверенный в dev.

## 9.2. Как создать PR (чтобы не упереться в main)
На странице **Compare changes** GitHub по умолчанию показывает **base: main** и **compare: main** — это не ошибка, просто стартовая подстановка. Для фич и экспериментов PR идёт **в dev**, не в main.

- **base** (куда мержим) → выберите **`dev`**.
- **compare** (откуда мержим) → выберите **вашу ветку** (например `feat/issue-12-ai-core` или `fix/...`).
- Затем нажмите **Create pull request**. Получится PR: ваша-ветка → dev.

В main попадаем только отдельным PR после проверки в dev (dev → main).

## 9.3. Pull Request правила
Каждый PR обязан:
- ссылаться на Issue
- иметь чеклист (линт, тесты, миграции)
- содержать скриншоты UI (если фронт)
- иметь автотесты (или отдельный Issue на тесты, но до merge в main)

## 9.4. CI (GitHub Actions)
На каждый PR в `dev/test/main` запускается:
- lint
- typecheck
- unit tests
- integration tests
- build

На merge в `main`:
- build + deploy production

## 9.5. Issue менеджмент
### Labels
- type: feature|bug|chore
- area: frontend|backend|worker|infra|qa|design
- priority: p0|p1|p2
- stage: mvp|stage2|stage3

### Issue шаблон
В каждом Issue обязательно:
- Контекст (зачем)
- Скоуп (что входит/не входит)
- Acceptance Criteria (проверяемые пункты)
- Edge cases
- Дизайн/макеты (если есть)
- Тест-кейсы

## 9.6. Релизы
- Релиз — это merge в `main` с тегом `v0.x.y`.
- Release notes составляются из закрытых issues.

## 9.7. Деплой (Vercel) и одинаковый интерфейс dev/main
Чтобы на **dev** и **main** был один и тот же интерфейс (выбор моделей примерки/видео, **выбор модели в архиве при просмотре фото**, лаборатория):
- Оба окружения должны собираться из **одного и того же кода** (один коммит на `dev` и `main` после синхронизации).
- **Preview-деплои** (ссылки вида `tvoisty-xxx-helensol-1s-projects...`) собираются из ветки PR — там может быть старая версия без выбора моделей. Не сравнивать интерфейс по preview-ссылке с production.
- В коде **нет** скрытия выбора моделей или Лаборатории по `NODE_ENV` / `import.meta.env.DEV`: один интерфейс везде. Если розовый (preview) и зелёный (main) отличаются — проверить, что деплой main и dev идут с одних и тех же веток/коммитов.

**Что проверить в Vercel, если «из архива при просмотре фото нет выбора модели»:**
1. В репозитории выбор «Модель для видео» в модалке архива уже есть (между «Купить в магазине» и «Анимировать»). Если на сайте его нет — задеплоена старая сборка.
2. **Dashboard Vercel → Project → Deployments:** какой коммит у последнего Production (main) и у Preview (dev/PR)? Должны быть те коммиты, где добавлен выбор модели в архиве.
3. **Пересобрать:** сделать пустой коммит и push в `main` (или merge в `main` из текущей ветки), чтобы Vercel заново собрал production. Для dev — push в `dev` или merge в ветку, с которой связан dev.
4. После деплоя в архиве при открытии фото должны быть: «Купить в магазине», блок **«Модель для видео»** (выпадающий список), «Анимировать», «Скачать фото», «Поделиться».

